package me.ionar.salhack.module.exploit;

import me.ionar.salhack.events.network.EventNetworkPacketEvent;
import me.ionar.salhack.events.packet.PacketEvent;
import me.ionar.salhack.module.Module;
import me.ionar.salhack.module.Value;
import me.zero.alpine.fork.listener.EventHandler;
import me.zero.alpine.fork.listener.Listener;
import net.minecraft.block.BlockContainer;
import net.minecraft.network.play.client.CPacketEntityAction;
import net.minecraft.network.play.client.CPacketPlayerTryUseItemOnBlock;
import net.minecraft.util.math.BlockPos;

public class NoInteractModule extends Module {

    public final Value<Boolean> ContainerOnly = new Value<Boolean>("ContainerOnly", new String[] {"PO"}, "Don't work on storage items only.", false);

    public NoInteractModule()
    {
        super("NoInteract", new String[]
                { "NoInteract" }, "Don't interact with stuff like chests and anvils.", "NONE", 0xDB6824, ModuleType.EXPLOIT);
    }

    private boolean shouldStop = false;

    @EventHandler
    private Listener<EventNetworkPacketEvent> UseItem = new Listener<>(p_Event ->
    {
         if (p_Event.getPacket() instanceof CPacketPlayerTryUseItemOnBlock && !mc.player.isSneaking()) {
             CPacketPlayerTryUseItemOnBlock packet = ((CPacketPlayerTryUseItemOnBlock) p_Event.getPacket());
             BlockPos pos = packet.getPos();

             if (ContainerOnly.getValue() && !(mc.world.getBlockState(pos).getBlock() instanceof BlockContainer))
                 return;

             mc.player.connection.sendPacket(new CPacketEntityAction(mc.player, CPacketEntityAction.Action.START_SNEAKING));
             shouldStop = true;
         }
    });

    @EventHandler
    private Listener<CPacketPlayerTryUseItemOnBlock> UseItemOnBlock = new Listener<>(p_Event ->
    {
            if(p_Event instanceof CPacketPlayerTryUseItemOnBlock && shouldStop && NoInteractModule.this.isEnabled()) {

                CPacketPlayerTryUseItemOnBlock packet = ((CPacketPlayerTryUseItemOnBlock)p_Event);
                BlockPos pos = packet.getPos();

                if(ContainerOnly.getValue() && !(mc.world.getBlockState(pos).getBlock() instanceof BlockContainer)) return;

                mc.player.connection.sendPacket(new CPacketEntityAction(mc.player, CPacketEntityAction.Action.STOP_SNEAKING));
                shouldStop = true;
            }
    });

    @Override
    public void onDisable() {
        shouldStop = false;
    }

}
